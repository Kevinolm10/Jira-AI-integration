{% extends 'base.html' %}

{% block title %}AI Chat - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3>Jira AI Assistant</h3>
            </div>
            <div class="card-body">
                <div id="chat-messages" class="mb-3" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
                    <!-- Chat messages will appear here -->
                </div>
                
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="user-input" class="form-control" placeholder="Ask me about Jira issues..." required>
                        <button type="submit" class="btn btn-primary" id="send">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const chatContainer = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
    e.preventDefault(); // Stop default form submission

    const message = userInput.value.trim();
    if (!message) return;

    // Disable input while processing
    userInput.disabled = true;
    const submitBtn = chatForm.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    try {
    // Show user's message immediately
    addUserMessage(message);

    // Clear input
    userInput.value = '';

    // Send to server and handle streaming response
    await sendMessageAndStream(message);

    } catch (error) {
    console.error('Error:', error);
    showErrorMessage('Sorry, something went wrong. Please try again.');
    } finally {
    // Re-enable input
    userInput.disabled = false;
    submitBtn.disabled = false;
    submitBtn.textContent = originalBtnText;
    userInput.focus();
    }
    });

    // Add user message to chat
    function addUserMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'user-message';
    messageDiv.innerHTML = `<strong>You:</strong> ${escapeHtml(message)}`;
    chatContainer.appendChild(messageDiv);
    scrollToBottom();
    }

    // Create empty bot message container
    function createBotMessage() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'bot-message message-loading';
    messageDiv.innerHTML = '<strong>AI:</strong> <span class="response-content">Thinking...</span>';
    chatContainer.appendChild(messageDiv);
    scrollToBottom();
    return messageDiv.querySelector('.response-content');
    }

    // Show error message
    function showErrorMessage(error) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'bot-message';
    messageDiv.style.borderLeftColor = '#dc3545';
    messageDiv.style.background = '#f8d7da';
    messageDiv.innerHTML = `<strong>Error:</strong> ${escapeHtml(error)}`;
    chatContainer.appendChild(messageDiv);
    scrollToBottom();
    }

    // Send message and handle streaming response
    async function sendMessageAndStream(message) {
    // Create FormData (matches Django expectation)
    const formData = new FormData();
    formData.append('user_input', message);

    // Make request to Django endpoint
    const response = await fetch(window.location.pathname, { // Current URL
    method: 'POST',
    body: formData,
    headers: {
    'X-CSRFToken': getCsrfToken() // Django CSRF protection
    }
    });

    if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
    }

    // Create bot message container
    const botResponseElement = createBotMessage();
    botResponseElement.textContent = ''; // Clear "Thinking..." text
    botResponseElement.parentElement.classList.remove('message-loading');

    // Get stream reader
    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    // Read stream chunks
    while (true) {
    const { done, value } = await reader.read();

    if (done) break;

    // Decode chunk and add to bot message
    const chunk = decoder.decode(value, { stream: true });
    botResponseElement.textContent += chunk;

    // Auto-scroll to bottom
    scrollToBottom();
    }
    }

    // Utility functions
    function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
    }

    function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
    document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }

    // Focus input on page load
    userInput.focus();
    });
</script>
{% endblock %}
